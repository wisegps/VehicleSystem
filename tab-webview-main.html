<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="css/mui.min.css">
		<link rel="stylesheet" href="css/style.css" />
		<link href="css/iconfont.css" rel="stylesheet" />
		<style>
			html,
			body {
				background: url('ui/back2.png') no-repeat fixed top;
				background-color: #080808;
				background-size:100%;
				overflow: hidden;
			}
			header {
				box-sizing: content-box;
				background-color: #b01526!important;
				background: url('ui/navbar.png') no-repeat fixed top!important;
				background-size:100%!important;
				border-bottom: 0px solid rgba(247, 247, 247, 0)!important;
			}
			#title {
				color:white!important;
			}
			.mui-popover {
				height: 100px;
				width: 150px;
			}
			
			.mui-content{
				background: none;
				/*overflow: hidden;*/
			}
			#topPopover {
				position: fixed;
				top: 16px;
				right: 6px;
				font-size: 14px;
			}
			#topPopover .mui-popover-arrow {
				left: auto;
				right: 6px;
			}
			.arrow {
				padding-top: 10px;
				color: #fff;
			}
			.mui-tab-item .mui-badge {
				margin-left: -5px!important;
			    padding: 4px 4px!important;
			    border-radius: 50%;
			}
			
			.mui-bar-tab {
				text-align: center;
				height: 74px;
			}

			.mui-bar-tab .mui-tab-item.mui-active {
			    color: #F00000;
			}
			
			.mui-bar-tab .mui-tab-item {
			    /*color: #BEDFEF;*/
			}
			
			.mui-bar {
				background-color: transparent;
				background-color: #080808;
				background: url('ui/tabbar2.png') no-repeat;
				background-size:100%;				
			    -webkit-box-shadow: 0 0 0px rgba(0,0,0,.85); 
			    box-shadow: 0 0 0px rgba(0,0,0,.85); 
			    line-height: 50px;
			}
			
			.mui-bar-nav .mui-badge {
			    margin-left: -22px!important;
			    /* padding: 4px 4px!important; */
			    /* border-radius: 50%; */
			    margin-top: 7px;
			}
			
			#alertBadge, #notifyBadge {
				display: none;
			}
			
			#tabbar {
				width: 85%;
				vertical-align: middle;
			}
			
			.tabbar-label {
				position: absolute;
				vertical-align: middle;
				color: #fff;
				font-size: 11px;
				margin-top: 4px;
			}
			
			.tabbar-label.control {
				margin-left: -77%;
			}
			
			.tabbar-label.flameout {
				margin-left: -52%;
			}
			
			.tabbar-label.more {
				margin-left: -22%;
			}
			
			
			.mui-car-info{
				/*margin-top: 44px;*/
			}
			
			.status1 {
				padding-top: 18px;
				padding-left: 20px;
				padding-right: 19px;
				color: #fff;
				text-align: center;
				font-size: 12px;
			}
			
			.light {
				height: 20px;
				vertical-align: middle;
				padding-bottom: 4px;
			}
			
			.battery {
			    height: 20px;
			    padding-right: 35px;
			}
			
			#battery {
			    position: absolute;
			    margin-top: -5px;
			    margin-left: -30px;
			    color: #fff;
			}
			
			
			.title-add{
				
				line-height: 40px; 
				margin: 0 auto;
				z-index: 999;
				display: inline-block; 
				width: 60%;
				font-weight: 700; 
				font-size: 12px; 
				color: #FFFFFF;
				text-overflow: ellipsis; 
				white-space: nowrap; 
				overflow: hidden;
			}
			
			.status2 {
				width: 100%;
				padding-top: 5px;
				padding-bottom: 5px;
				padding-left: 20px;
				padding-right: 20px;
				height: 40px;
			}
			
			
			.power {
			    height: 100px;
			    width: 100%;
			    /*margin-top: 5%;*/
			    position: relative;
			    bottom: 10px;
			}
			
			
			.car-image{
				width: 64%;
				/*height: 400px;*/  
				margin-top: -40px; 
				position: absolute; 
				top: 0;
			}
			
			.sport-car{
				width: 80%; 
				height: 100%; 
				position: absolute;
			}
			
			.show-vehicle{
				width: 100%;
				/*height:70%;*/
				/*margin-top: 44px;*/
			}
			
			.show-car-bg{
				
				position: relative;
			}
			
			.tab-bottom-nav{
				width: 100%;
				/*height: 30%;*/
				position: absolute;
				bottom: 0;
				z-index: 999;
				overflow: hidden;
			}
			
			.mui-bar .mui-icon {
			    font-size: 28px;
			}
			
			.mui-bar-tab .mui-tab-item .mui-icon {
			    top: 32px;
			}
			
			.mui-bar-tab .mui-tab-item .mui-icon~.mui-tab-label {
			    padding-top: 10px;
			    margin-bottom: -10px;
			    font-size: 13px;
			}	
			.mui-title{
				color: floralwhite;
				font-weight: 700;
			}
			
			.lock-unlock {
				/*position: absolute;*/
			    width: 100%;
			    height: 100%;
			    bottom: 0px;
			    margin-bottom: -5px;
			    float: left;
			}		
			
			.lock-unlock .img-unlock {
				width: 50%;
				/*padding-right: 10px;*/
				float:right;
			}
			
			.lock-unlock .img-stop {
				position: absolute;
				width: 30%;
    			left: 35%;
    			top: 18%;
			}
			
			.lock-unlock .img-lock {
				width: 50%;
				/*padding-left: 10px;*/
			}
			#content1 {
				height: 2px;
			}
		</style>
	</head>

	<body>
		<header id="header" class="mui-bar mui-bar-nav"> 
			<a id="vehicle" class="mui-action-menu mui-icon iconfont icon-list mui-pull-left" style="color: #fff"></a>
			<a id="playback" class="mui-icon iconfont icon-xianshiguiji mui-pull-left" style="color: #fff;display: none;"></a>
			<a id="more-set" class="mui-icon iconfont icon-More mui-pull-right" style="color: #fff;"></a>
			<a id="alert" class="mui-icon iconfont icon-baojing mui-pull-right mui-hidden" style="color:#FFFFFF"><span id="alertBadge" class="mui-badge">0</span></a>			
			<h1 id="title" class="mui-title" data-i18n="app.name">车管云</h1>
		</header>
		
		<!--<div style="display: none;">
			<nav class="mui-bar mui-bar-tab" style="display: none;background-color: #080808;" id="nav_bar">
				<a id="default1" class="mui-tab-item mui-active" >
					<span class="mui-icon iconfont icon-write"></span>
					<span class="mui-tab-label" data-i18n="main.home" id="default12">控制</span>
				</a>
				<a id="location" class="mui-tab-item" href="tab-webview-subpage-map.html">
					<span class="mui-icon iconfont icon-weizhiicon"><span id="alertTip" class="mui-badge mui-hidden"></span></span>
					<span class="mui-tab-label" data-i18n="main.monitor">监控</span>
				</a>
				<a id="more" class="mui-tab-item" href="tab-webview-subpage-more.html">
					<span class="mui-icon iconfont icon-More"></span>
					<span class="mui-tab-label" data-i18n="main.more">更多</span>
				</a>
			</nav>
			<div id="iframeHtml">
				<iframe src="tab-webview-subpage-map.html" width="100%" height="100%" id="mapiframe" ></iframe>
			</div>
		</div>-->
		<div id="content" class="mui-content">
			<div class="show-vehicle" id="show-car-image">
				<div class="mui-row status1" style="position: relative;z-index: 999;">
					<span class="mui-pull-left">
						<span style="line-height: 20px; margin-left: -9px;"><img class="light" id="gps" src="ui/redStatus.png">GPS</span><br/>
						<span style="line-height: 20px; margin-left: -9px;"><img class="light" id="online" src="ui/redStatus.png"><span id="on-text">离线</span></span>
					</span>
					<span  id="address" class="title-add" >
						<!--深圳市宝安区留仙三路36号创兴达商务大厦5楼，5012室-->
					</span>
					<span class="mui-pull-right" style="line-height: 50px">
						<img class="battery" src="ui/battery.png" style=""><span id='battery'>0.0V</span>
					</span>
				</div>
				
			<!--<div class="mui-row status2">
				<span class="mui-pull-left" style="line-height: 20px">
					<img id="alert" src="ui/alert.png" style="width: 30px; vertical-align: middle; display: none;">
				</span>
				<span class="mui-pull-left" style="line-height: 20px">
					<img id="power" src="ui/cutPower.png" style="width: 30px; vertical-align: middle; display: none;">
				</span>
				<span class="mui-pull-left" style="line-height: 30px">
					<img id="start" src="ui/start.png" style="width: 30px; vertical-align: middle; display: none;">
				</span>				
				&nbsp;
				<span class="mui-pull-right" style="line-height: 20px">
					<img id="door" src="ui/doorOpen.png" style="width: 30px; vertical-align: middle; display: none;">
				</span>				
			</div>			-->
				
				<!--<div class="show-car-bg" style="z-index: 1;">
					<div class="sport-car" style="z-index: 999;">
						<img src="imagecar/sporte_car_close.png" id="show-car-state" class="sport-car" style=" bottom: 40px;"/>
						<img src="imagecar/min_light1.png" id="line1" class="sport-car" style=" z-index: 999; bottom: 40px;" />
					</div>
					<img src="imagecar/sporte_car_show_bg.jpg" class="sport-car" />
				</div>	-->
				
				<div class="show-car-bg" style="width: 100%">
					<div style="width: 100%; left: 18%; margin: 0 auto; position: relative; top: -50px; ">
						<img id="front-left-door" src="imagecar/close_door_left_front.png" class="car-image" />
						<img id="back-left-door" src="imagecar/close_door_left_back.png" class="car-image" />
						<img id="front-right-door" src="imagecar/close_door_right_front.png" class="car-image"/>
						<img id="back-right-door" src="imagecar/close_door_right_back.png" class="car-image" />
						<img src="imagecar/car_body.png" style="width: 64%; margin-top: -40px;"/>
						<img id="front-right-window" src="imagecar/front_right_window.png" class="car-image" style="display: none;"/>
						<img id="front-left-window" src="imagecar/front_left_window.png" class="car-image" style="display: none;"/>
						<img id="back-right-window" src="imagecar/back_right_window.png" class="car-image" style="display: none;"/>
						<img id="back-left-window" src="imagecar/back_left_window.png" class="car-image" style="display: none;"/>
						<img id="open-behind-light" src="imagecar/open_behind_light2.png" class="car-image" style="display: none;"/>
						<img id="front-behind-blue-light" src="imagecar/open_front_behind.png" class="car-image" style="display: none;" />
					</div>
				</div>
			</div>
		<div class="tab-bottom-nav">
			<div class="tab-bottom-nav-lock">
				<div class="lock-unlock">
					<img id="lock" class="img-lock" src="imagecar/lockoff.png">
					<img id="start-or-stop" class="img-stop" src="imagecar/stop.png">
					<img id="unlock" class="img-unlock" src="imagecar/unlockoff.png">			
				</div>
				<div class="lock-unlock">
					<img id="tail" class="img-lock" src="imagecar/tailoff.png">
					<img id="find" class="img-unlock" src="imagecar/findoff.png">
				</div>
			</div>
		</div>
		<div id="content1" class="mui-content" style="display: none;"></div>
		<script src="./js/mui.min.js"></script>
		<script src="./js/immersed.js" ></script>
		<script src="./js/menu.js" ></script>		
		<script src="js/wistorm/wspub.js"></script>
		<script src="js/wistorm/define.js"></script>
		<script src="js/wistorm/wistorm.js"></script>
		<script src="js/wistorm/md5.js"></script>
		<script src="js/app.js"></script>	
		<script src="js/mapjs/global.js" type="text/javascript"></script>
		<script src="js/mapjs/define.js" type="text/javascript"></script>
		<script src="js/mapjs/global.js" type="text/javascript"></script>
		<!--<script type="text/javascript" src="http://ditu.google.cn/maps/api/js?key=AIzaSyAPNfIol28jBmFgzU-ubjI_nVE8fIEtdjg"></script>-->
		<!--<script src="https://maps.googleapis.com/maps/api/js?v=3&key=AIzaSyAPNfIol28jBmFgzU-ubjI_nVE8fIEtdjg"></script>-->
		<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=647127add68dd0a3ed1051fd68e78900"></script>
		<!--<script src="js/mapjs/markerwithlabel.js" type="text/javascript"></script>-->
		<!--<script src="js/mapjs/gomap.js" type="text/javascript"></script>-->		
		<script src="js/mapjs/bmap.js" type="text/javascript"></script>
		<script src="js/mapjs/wisemap.js" type="text/javascript"></script>
		<!--<script src="js/base-loading.js"></script>-->
		<script type="text/javascript" charset="utf-8"> 
			 //mui初始化
			 mui.init();
			 mui.plusReady(function() {
				var titleAddress;
				var _map = new bmap(document.getElementById('content1'), {lon:114.302786, lat:30.631178}, 15);
				var start_or_stop = document.getElementById('start-or-stop');
				var gps = document.getElementById('gps');
				var online = document.getElementById('online');
				var battery = document.getElementById("battery");
				var acc = document.getElementById("start-or-stop");
				var lock = document.getElementById("lock");
				var unlock = document.getElementById('unlock');
				var tail = document.getElementById('tail');
				var findCar = document.getElementById('find');
				var frontRightDoor = document.getElementById('front-right-door');
				var frontLeftDoor = document.getElementById('front-left-door');
				var backRightDoor = document.getElementById('back-right-door');
				var backLeftDoor = document.getElementById('back-left-door');
				var frontBackLinght = document.getElementById('open-behind-light');
				var frontBehindLinght = document.getElementById('front-behind-blue-light');
				var frontRightWindow = document.getElementById('front-right-window');
				var frontLeftWindow = document.getElementById('front-left-window');
				var backRightWindow = document.getElementById('back-right-window');
				var backLeftWindow = document.getElementById('back-left-window');
				var onText = document.getElementById('on-text');
				var showCarState= document.getElementById('show-car-state');
				var lockStatus = false;
				var StandStatus = false;
				var startStatus = false;
				var accStatus = false;
				var expireIn;
				var now = new Date();
				var line1 = document.getElementById('open-behind-light');
				 //车灯的闪烁
				var flat = 0;
				var timer;	
	 			function changeline (){
	 				flat++;
					if(flat <5){
						if(line1.style.display == 'none'){
							line1.style.display = 'block';
						}else {
							line1.style.display = 'none';
						}
					}else {
						flat = 0;
						clearInterval(timer);
					}
				 }
				//创建子页面，首个选项卡页面显示，其它均隐藏；
				var backButtonPress = 0;
				mui.back = function(event) {
					console.log(backButtonPress);
					backButtonPress++;
					if (backButtonPress > 1) {
						plus.runtime.quit();
					} else {
						app.toast("再按一次退出");
					}
					setTimeout(function() {
						backButtonPress = 0;
					}, 1000);
					return false;
				};
				var title = document.getElementById("title");
				window.addEventListener('refreshTitle', function(event){
					if(event.detail.name != null){
						title.innerHTML = event.detail.name;
					}
				});	
				//地图对话框
				var playbackPage = mui.preload({
					"id": 'playback',
					"url": 'playback.html'
				});	
				//预加载地图页面	
				_baidumap = mui.preload({
					"id":'tab-webview-subpage-badumap',
					"url":'tab-webview-subpage-badumap.html'
				});
				var maps = document.getElementById('address');
				maps.addEventListener('tap', function(evet){
					_baidumap.show("pop-in");
				});
				//预加载更多设置页面
				var more_setpage = mui.preload({
					"id":'tab-webview-subpage-more-set',
					"url":'tab-webview-subpage-more-set.html'
				});
				var more_set = document.getElementById('more-set');
				more_set.addEventListener('tap', function(evet){
					more_setpage.show("pop-in");
				});
				//定时刷新报警页面
				var timerAlertCount = function(){
					setTimeout(function(){
						timerAlertCount();
					}, 10000);
				}
				// 获取报警计数
				timerAlertCount();
				window.addEventListener('refreshAlertBadge', function(event){
					getAlertCount();
				});		
				//预加载报警页面
				var alertButton = document.getElementById('alert');
				alertButton.addEventListener('tap', function(event) {
					var alertPage = plus.webview.getWebviewById('alert-list-main');
					mui.fire(alertPage, 'refreshAlertList', null);	
					setTimeout(function(){
						alertPage.show("pop-in");
					}, 200);
				});	
				//主页面地址描述
				function locationTitle(lon, lat){
					var myGeo = new BMap.Geocoder();     
                    // 根据坐标得到地址描述   
                    var point = new BMap.Point(lon, lat);
                     	myGeo.getLocation(point, function (result){     
                                if (result){ 
                                	var di = 2000;
                                	var shortpoint = -1;
						            for (i = 0; i < result.surroundingPois.length; i++) {
						                var d = _map.getDistance(result.surroundingPois[i].point, point);
						                if (d < di) {
						                    shortpoint = i;
						                    di = d;
						                }
						            }
									var ra = result.addressComponents;
						            if (shortpoint >= 0) {
						                address = ra.city +ra.district+ ra.street+ ra.streetNumber +'，离' + result.surroundingPois[shortpoint].title + di.toFixed(0) + '米';
						            } else {
						                address = result.address;
						            }
                                	titleAddress = address;
                                	var baidumaps = document.getElementById('address');
                                	if(titleAddress != ''){
                                		baidumaps.disabled = false;
                                		baidumaps.innerHTML ='<span class="mui-icon mui-icon-location" style = "font-size: 15px;">&nbsp;</span>'+titleAddress;
                                	}else{
                                		baidumaps.disabled = true;
                                		baidumaps.innerHTML = '<span class="mui-icon mui-icon-location" style = "font-size: 15px;">&nbsp;</span>'+'未定位';
                                	}
                                }
                       });
				}
				// 刷新主页面事件
				window.addEventListener('refreshVehicle', function(event) {
					var vehicle = event.detail.vehicle;
					if(vehicle){
						expireIn = new Date(vehicle.params.serviceExpireIn);
						if(expireIn < now){
							var baidumaps = document.getElementById('address');
								baidumaps.disabled = true;
                            	baidumaps.innerHTML = '<span class="mui-icon mui-icon-location" style = "font-size: 15px;">&nbsp;</span>'+'服务已到期！';
						}else{
							var v = vehicle.activeGpsData;
							if (v != null) {
	                            locationTitle(v.lon, v.lat);
							}
							gps.src = vehicle.activeGpsData.gpsFlag === 2 ? 'ui/greenStatus.png': 'ui/redStatus.png';
							online.src = getOnLine(vehicle) ? 'ui/greenStatus.png': 'ui/redStatus.png';
							onText.innerHTML = getOnLine(vehicle) ? '在线' : '离线';
							battery.innerHTML = (vehicle.activeGpsData.battery||0).toFixed(1) + 'V';
							accStatus = vehicle.activeGpsData.status.indexOf(8196) > -1;
	//						accStatus = vehicle.params.vstatus.P20C_ACC;
							acc.src = accStatus ? 'imagecar/start.png':'imagecar/stop.png';
//							alert(accStatus);
							unlock.src = vehicle.activeGpsData.status.indexOf(IOT_STATUS.STATUS_FORTIFY) > -1 ? 'imagecar/unlockoff.png':'imagecar/unlockon.png';
							lock.src = vehicle.activeGpsData.status.indexOf(IOT_STATUS.STATUS_FORTIFY) > -1 ? 'imagecar/lockon.png':'imagecar/lockoff.png';
							//赛车
	//						showCarState.src = vehicle.activeGpsData.status.indexOf(IOT_STATUS.STATUS_FORTIFY) > -1 ? 'imagecar/sporte_car_close.png':'imagecar/sporte_car_open.png';
	//						showCarState.src = vehicle.activeGpsData.status.indexOf(IOT_STATUS.STATUS_FORTIFY) > -1 ? 'imagecar/sporte_car_open.png':'imagecar/sporte_car_close.png';
	//						console.log('acc src:' + acc.src);
							var vpv = vehicle.params.vstatus;
								if(vpv){
										frontRightDoorState = vpv.P20C_RIGHT_FRONT_DOOR;
										frontLeftDoorState = vpv.P20C_LEFT_FRONT_DOOR;
										backRightDoorState = vpv.P20C_RIGHT_BACK_DOOR;
										backLeftDoorState = vpv.P20C_LEFT_BACK_DOOR;
										frontRightWindowState = vpv.P20C_RIGHT_FRONT_WIN;
										frontLeftWindowState = vpv.P20C_LEFT_FRONT_WIN;
										backRightWindowState = vpv.P20C_RIGHT_BACK_WIN;
										backLeftWindowState = vpv.P20C_LEFT_BACK_WIN;
										tailState = vpv.P20C_TRUNK;
//										if(frontRightDoorState == false && frontLeftDoorState == false && backRightDoorState == false && backLeftDoorState == false){
//											frontLeftDoor.src = vehicle.activeGpsData.status.indexOf(8212) > -1 ? 'imagecar/open_door_left_front.png': 'imagecar/close_door_left_front.png';
//											frontRightDoor.src = 'imagecar/close_door_right_front.png';
//											backRightDoor.src = 'imagecar/close_door_right_back.png';
//											backLeftDoor.src = 'imagecar/close_door_left_back.png';	
//										}else{
											frontRightDoor.src = frontRightDoorState ? 'imagecar/open_door_right_front.png':'imagecar/close_door_right_front.png';
											frontLeftDoor.src = frontLeftDoorState ? 'imagecar/open_door_left_front.png':'imagecar/close_door_left_front.png';
											backRightDoor.src = backRightDoorState ? 'imagecar/open_door_right_back.png':'imagecar/close_door_right_back.png';
											backLeftDoor.src = backLeftDoorState ? 'imagecar/open_door_left_back.png':'imagecar/close_door_left_back.png';
//										}
										tail.src = tailState ? 'imagecar/tailon.png':'imagecar/tailoff.png';
										frontBehindLinght.style.display = vpv.P20C_LITTLE_LAMP == true ? 'block':'none';
								}else{
										frontRightDoor.src = 'imagecar/close_door_right_front.png';
										frontLeftDoor.src = 'imagecar/close_door_left_front.png';
										backRightDoor.src = 'imagecar/close_door_right_back.png';
										backLeftDoor.src = 'imagecar/close_door_left_back.png';
										tail.src = 'imagecar/tailoff.png';
										frontBehindLinght.style.display = 'none';
									}
							startStatus = vehicle.activeGpsData.status.indexOf(IOT_STATUS.STATUS_REMOTE_START) > -1;
						}
					}else{
						var did = event.detail.did;
						var v ;
						app.getDevice(did, function(vehicle){
							if(vehicle != null){
								expireIn = new Date(vehicle.params.serviceExpireIn);
								if(expireIn < now){
									var baidumaps = document.getElementById('address');
										baidumaps.disabled = true;
                            			baidumaps.innerHTML = '<span class="mui-icon mui-icon-location" style = "font-size: 15px;">&nbsp;</span>'+'服务已到期！';
								}else{
									v = vehicle.activeGpsData;
									if (v != null) {
	                                	locationTitle(v.lon, v.lat);
	                              		
									gps.src = vehicle.activeGpsData.gpsFlag === 2 ? 'ui/greenStatus.png': 'ui/redStatus.png';
									online.src = getOnLine(vehicle) ? 'ui/greenStatus.png': 'ui/redStatus.png';
									onText.innerHTML = getOnLine(vehicle) ? '在线' : '离线';
									battery.innerHTML = (vehicle.activeGpsData.battery||0).toFixed(1) + 'V';
	//								acc.src = vehicle.activeGpsData.status.indexOf(8196) > -1 ? 'images/flameOut.png':'images/flameOutOff.png';
									accStatus = vehicle.activeGpsData.status.indexOf(8196) > -1;
//									alert(accStatus);
	//								accStatus = vehicle.params.vstatus.P20C_ACC;
									acc.src = accStatus ? 'imagecar/start.png':'imagecar/stop.png';
									unlock.src = vehicle.activeGpsData.status.indexOf(IOT_STATUS.STATUS_FORTIFY) > -1 ? 'imagecar/unlockoff.png':'imagecar/unlockon.png';
									lock.src = vehicle.activeGpsData.status.indexOf(IOT_STATUS.STATUS_FORTIFY) > -1 ? 'imagecar/lockon.png':'imagecar/lockoff.png';
	//								showCarState.src = vehicle.activeGpsData.status.indexOf(IOT_STATUS.STATUS_FORTIFY) > -1 ? 'imagecar/sporte_car_close.png':'imagecar/sporte_car_open.png';
	//								showCarState.src = vehicle.activeGpsData.status.indexOf(IOT_STATUS.STATUS_FORTIFY) > -1 ? 'imagecar/sporte_car_open.png':'imagecar/sporte_car_close.png';
	//								console.log('acc src:' + acc.src);
									lockStatus = vehicle.activeGpsData.status.indexOf(IOT_STATUS.STATUS_LOCK) > -1;
									StandStatus = vehicle.activeGpsData.status.indexOf(IOT_STATUS.STATUS_FORTIFY) > -1;
	//								alert.style.display = vehicle.activeGpsData.alerts && vehicle.activeGpsData.alerts.length > 0 ? 'block': 'none';
	//								power.style.display = lockStatus ? 'block': 'none';
	//								lockStatus?changeline ():line1.src = 'imagecar/min_light1.png';
									
	//								door.style.display = vehicle.activeGpsData.status.indexOf(8212) > -1 ? 'block': 'none';
									var vpv = vehicle.params.vstatus;
									if(vpv){
										frontRightDoorState = vpv.P20C_RIGHT_FRONT_DOOR;
										frontLeftDoorState = vpv.P20C_LEFT_FRONT_DOOR;
										backRightDoorState = vpv.P20C_RIGHT_BACK_DOOR;
										backLeftDoorState = vpv.P20C_LEFT_BACK_DOOR;
										frontRightWindowState = vpv.P20C_RIGHT_FRONT_WIN;
										frontLeftWindowState = vpv.P20C_LEFT_FRONT_WIN;
										backRightWindowState = vpv.P20C_RIGHT_BACK_WIN;
										backLeftWindowState = vpv.P20C_LEFT_BACK_WIN;
										tailState = vpv.P20C_TRUNK;
//										if(frontRightDoorState == false && frontLeftDoorState == false && backRightDoorState == false && backLeftDoorState == false){
//											frontLeftDoor.src = vehicle.activeGpsData.status.indexOf(8212) > -1 ? 'imagecar/open_door_left_front.png': 'imagecar/close_door_left_front.png';
//											frontRightDoor.src = 'imagecar/close_door_right_front.png';
//											backRightDoor.src = 'imagecar/close_door_right_back.png';
//											backLeftDoor.src = 'imagecar/close_door_left_back.png';	
//										}else{
											frontRightDoor.src = frontRightDoorState ? 'imagecar/open_door_right_front.png':'imagecar/close_door_right_front.png';
											frontLeftDoor.src = frontLeftDoorState ? 'imagecar/open_door_left_front.png':'imagecar/close_door_left_front.png';
											backRightDoor.src = backRightDoorState ? 'imagecar/open_door_right_back.png':'imagecar/close_door_right_back.png';
											backLeftDoor.src = backLeftDoorState ? 'imagecar/open_door_left_back.png':'imagecar/close_door_left_back.png';
//										}
										tail.src = tailState ? 'imagecar/tailon.png':'imagecar/tailoff.png'
										frontBehindLinght.style.display = vpv.P20C_LITTLE_LAMP == true ? 'block':'none';
									}else{
										frontRightDoor.src = 'imagecar/close_door_right_front.png';
										frontLeftDoor.src = 'imagecar/close_door_left_front.png';
										backRightDoor.src = 'imagecar/close_door_right_back.png';
										backLeftDoor.src = 'imagecar/close_door_left_back.png';
										tail.src = 'imagecar/tailoff.png';
										frontBehindLinght.style.display = 'none';
									}
									
								}
							}
							}	
						});
					}
				});
				var lockButton = document.getElementById('lock');
				lockButton.addEventListener('tap', function(event) {
					console.log('lock');
					var cmdType = IOT_CMD.VEHICLE_CONTORL;
					var type = 0;
					var remark = '设防';
					var params = {
						'flag': 2,
						'switch': 1
					};
					var currentVehicle = app.getCurrentVehicle();
					if(expireIn < now){
							alert("服务已到期,请充值续费！");
							renew(currentVehicle);
						}else{
					if(currentVehicle){
						plus.nativeUI.showWaiting("设防中...");
						app.sendCommand(currentVehicle.did, cmdType, params, type, remark, 5, function(err) {
							if(err) {
								plus.nativeUI.closeWaiting();
								app.toast(err);
								return;
							}
							var width = app.getState().geofenceWidth || 200;
							app.getDevice(currentVehicle.did, function(vehicle){
								var lon = vehicle.activeGpsData.lon;
								var lat = vehicle.activeGpsData.lat;
								app.setGeofence(currentVehicle.did, lon, lat, width, function(err) {
									if(err) {
										return err;
									}
									plus.nativeUI.closeWaiting();
									app.toast('设防成功.');
									StandStatus = true;
									unlock.src = 'imagecar/unlockoff.png';
									lock.src = 'imagecar/lockon.png'; 
								});
							});
						});
					}else{
						app.toast('请选择车辆');	
					}
					}
				});	
				var unlockButton = document.getElementById('unlock');
				unlockButton.addEventListener('tap', function(event) {
					console.log('unlock');
					var cmdType = IOT_CMD.VEHICLE_CONTORL;
					var type = 0;
					var remark = '撤防';
					var params = {
						'flag': 2,
						'switch': 0
					};
					var currentVehicle = app.getCurrentVehicle();
					if(currentVehicle){
						if(expireIn < now){
								alert("服务已到期,请充值续费！");
								renew(currentVehicle);
						}else{
							plus.nativeUI.showWaiting("撤防中...");
							app.sendCommand(currentVehicle.did, cmdType, params, type, remark, 5, function(err) {
								if(err) {
									plus.nativeUI.closeWaiting();
									app.toast(err);
									return;
								}
								var width = 0;
								var lon = 0;
								var lat = 0;
								app.setGeofence(currentVehicle.did, lon, lat, width, function(err) {
									if(err) {
										return err;
									}
									plus.nativeUI.closeWaiting();
									app.toast('撤防成功.');
									StandStatus = false;
									unlock.src = 'imagecar/unlockon.png';
									lock.src = 'imagecar/lockoff.png';
								});
							});
						}	
					}else{
						app.toast('请选着车辆');						
					}
				});	
				var tailButton = document.getElementById('tail');
				tailButton.addEventListener('tap', function(event){
					var cmdType = IOT_CMD.VEHICLE_CONTORL;
					var type = 0;
					var remark = '打开尾箱';
					var params = {
						'flag': 64,
						'switch': 1
					};
					var title = '确认开启尾箱';
					var bts=["否","是"];
					var currentVehicle = app.getCurrentVehicle();
					if(currentVehicle){
						if(expireIn < now){
							alert("服务已到期,请充值续费！");
							renew(currentVehicle);
						}else{
								plus.nativeUI.confirm(title ,function(e){
									var i=e.index;
								if(i == 1){
									plus.nativeUI.showWaiting("打开尾箱中...");
									app.sendCommand(currentVehicle.did, cmdType, params, type, remark, 5, function(err) {
										if(err) {
											plus.nativeUI.closeWaiting();
											app.toast(err);
											return;
										}
										plus.nativeUI.closeWaiting();
										app.toast('尾箱打开成功.');
										StandStatus = false;
									});
								}
							},currentVehicle.name,bts);
						}
					}else{
						app.toast('请选着车辆');						
					}
				});
				
				var findButton = document.getElementById('find');
				findButton.addEventListener('tap', function(event){
					var cmdType = IOT_CMD.VEHICLE_CONTORL;
					var type = 0;
					var remark = '寻车';
					var params = {
						'flag': 32,
						'switch': 1
					};
					var currentVehicle = app.getCurrentVehicle();
					if(currentVehicle){
						if(expireIn < now){
							alert("服务已到期,请充值续费！");
							renew(currentVehicle);
						}else{
							plus.nativeUI.showWaiting("寻车中...");
							app.sendCommand(currentVehicle.did, cmdType, params, type, remark, 5, function(err) {
								if(err) {
									plus.nativeUI.closeWaiting();
									app.toast(err);
									return;
								}
								plus.nativeUI.closeWaiting();
								app.toast('寻车成功.');
							});
						}	
					}else{
						app.toast('请选着车辆');						
					}
					
				});
				
				var accButton = document.getElementById('start-or-stop');
				accButton.addEventListener('tap', function(event) {
					if(accStatus && !startStatus){
						app.toast('车辆启动时不能远程启动.');
						return;
					}
					var cmdType = IOT_CMD.VEHICLE_CONTORL;
					var type = 0;
					var remark = startStatus ?'熄火': '启动';
					var params = {
						'flag': 8,
						'switch': startStatus ? 0: 1
					};
					var waiting = startStatus? '车辆熄火...': '车辆启动...';
					var title = startStatus ? '确认熄火?': '确认启动';
					var msg = startStatus ? '熄火成功.': '启动成功.';
					var bts=["否","是"];
					var currentVehicle = app.getCurrentVehicle();
					if(currentVehicle){
						if(expireIn < now){
							alert("服务已到期,请充值续费！");
							renew(currentVehicle);
						}else{
							plus.nativeUI.confirm(title ,function(e){
								var i=e.index;
								if(i == 1){
									plus.nativeUI.showWaiting(waiting);
									app.sendCommand(currentVehicle.did, cmdType, params,type, remark, 5, function(err) {
										if(err) {
											plus.nativeUI.closeWaiting();
											app.toast(err);
											return;
										}
										plus.nativeUI.closeWaiting();
										app.toast(msg);
									});
								}
							},currentVehicle.name,bts);
						}	
					}else{
						app.toast('请选择车辆');
					}
				});
				
				function renew(currentVehicle){
					var pay_count = 1;
					var state = app.getState();
					var parent_month_fee = state.parent_month_fee || 5;
				    var parent_year_fee = state.parent_year_fee || 60;
				    var pay_fee = 0;
				    var remark;
				    var mode;
					var btnArray = [{title:"1年(" + parent_year_fee.toFixed(2) + "元)"},{title:"2年(" + (parent_year_fee*2).toFixed(2) + "元)"}];
					plus.nativeUI.actionSheet( {
						title:"续费管理",
						cancel:"取消",
						buttons:btnArray
					}, function(e){
						var index = e.index;
						switch (index){
							case 0:
								break;
							case 1:
								pay_count = 1;
								pay_fee = parent_year_fee * 1;
								remark = currentVehicle.did + ' - 续费1年'
								break;
							case 2:
								pay_count = 2;
								pay_fee = parent_year_fee * 2;
								remark = currentVehicle.did + ' - 续费2年'
								break;								
						}
						if(index === 0){
							return;
						}
						var bts=["取消","确认"];
							app.getUser(function(user){
								var balance = user.data.balance || 0;
								var chargePage = mui.preload({
										"id": 'charge',
										"url": 'charge.html'
									});	
								if(balance < pay_fee){
									plus.nativeUI.confirm("余额不足，请充值后再试 !", function(e) {
										var i = e.index;
										if(i == 1) {
											chargePage.show("pop-in");
										}	
									}, "确认充值", bts);
								}else{
									if(remark != null){
										plus.nativeUI.confirm("确认[" + remark + "]吗？", function(e) {
											var i = e.index;
											if(i == 1) {
												app.toast('续费成功');
												var vehiclePage = plus.webview.getWebviewById('vehicle-list');
												mui.fire(vehiclePage, 'refreshVehicle', null);
												var vehicleManege = plus.webview.getWebviewById('vehicle-manege-list');
												mui.fire(vehicleManege, 'refreshVehicle', null);
												app.pay(1, pay_count, remark, currentVehicle.did, function(err){
														if(err){
															app.toast(err);
															return;
														}else{
															currentPage = mui.currentWebview;
															mui.fire(currentPage, 'show', {mode: 1});
														}
												});
											}
										}, "确认续费", bts);
									}
								}	
						});
					});
				}
			});
			
		</script>
	</body>
</html>